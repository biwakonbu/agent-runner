# 製品要件定義書 (PRD): Multiverse IDE Core 永続化とスケジューラ

## 1. はじめに

本 PRD は、Multiverse IDE の Core 永続化およびスケジューリングアーキテクチャの要件を定義します。目標は、「設計（Design）」（WBS + ノード）を唯一の信頼できる情報源（Single Source of Truth）とし、「状態（State）」を「アクション（Actions）」の派生結果とすることで、堅牢で再現可能、かつ検証可能な開発環境を確立することです。

## 2. ゴールと目的

- **再現性**: アクションのリプレイや状態の再構築により、同じ設計（WBS + ノード）から一貫して同じ実装を生成できることを保証する。
- **可観測性**: すべてのアクション（設計変更、タスク実行、状態更新）の完全な履歴を追記型（Append-only）ログとして保持する。
- **スケーラビリティ**: 階層的な WBS や依存関係を持つタスクなど、複雑なプロジェクト構造をサポートする。
- **関心の分離**: 「設計（何を作るか）」、「状態（現在の状況）」、「履歴（何が起きたか）」、「成果物（コードベース）」を明確に分離する。

## 3. スコープ

- **永続化層**: 設計、状態、履歴のためのファイルベースリポジトリの実装。
- **スケジューラ**: 一元化された状態に基づいて動作する、依存関係を考慮したタスクスケジューラ。
- **アクションロギング**: すべての状態変更をアクションとして記録するメカニズム。
- **データモデル**: WBS、ノード、タスク、エージェント、アクションの JSON 構造の定義。

## 4. 機能要件

### 4.1. 永続化アーキテクチャ

- **ワークスペース構造**: データは `~/.multiverse/workspaces/<id>/` 以下の特定のサブディレクトリ（`design/`, `state/`, `history/`, `snapshots/`）に保存されなければならない。
- **設計リポジトリ (Design Repository)**:
  - WBS ルートを `design/wbs.json` に保存。
  - ノード定義を `design/nodes/<node-id>.json` に保存。
- **状態リポジトリ (State Repository)**:
  - ノードの実行時状態を `state/nodes-runtime.json` に保存。
  - スケジューラ状態（タスク）を `state/tasks.json` に保存。
  - エージェント状態を `state/agents.json` に保存。
- **履歴リポジトリ (History Repository)**:
  - すべてのアクションを `history/actions-YYYYMMDD.jsonl` に保存（追記のみ）。
- **原子的更新**: すべての状態/設計ファイルの更新は原子的でなければならない（一時ファイル書き込み後にリネーム）。

### 4.2. スケジューラロジック

- **依存関係解決**: 依存関係が満たされている場合（例：親ノードが計画済み、依存タスクが成功）にのみタスクをスケジュールする。
- **優先順位管理**: タスクの優先度と依存関係に基づいて実行順序を決定する。
- **エージェントディスパッチ**: 能力（Capabilities）と負荷に基づいて、タスクを利用可能なエージェントに割り当てる（`state/agents.json`）。
- **状態更新**: タスクイベント（開始、成功、失敗）発生時に `state/tasks.json` と `state/nodes-runtime.json` を自動的に更新する。

### 4.3. アクションロギング

- **イベントソーシングスタイル**: 設計や状態へのあらゆる変更は、履歴へのアクションレコード記録が先行しなければならない。
- **アクションタイプ**: `workspace.created`, `node.created`, `task.created`, `task.started`, `task.succeeded` 等。

## 5. 非機能要件

- **パフォーマンス**: スケジューラは 100 以上の、アクティブなタスクを効率的に処理できること。
- **耐久性**: クラッシュ時のデータ損失ゼロ（追記型履歴 + スナップショットに依存）。
- **言語**: Go 言語での実装（`internal/orchestrator`）。

## 6. データモデル

（詳細な JSON スキーマは `docs/multiverse-ide-core-persistence-and-scheduler.md` で定義）

## 7. 移行戦略

- 現在の `tasks/*.jsonl` ベースの実装は新しいアーキテクチャに置換される。
- 既存データの自動移行はこのフェーズでは予定されていない（内部保存フォーマットの破壊的変更）。
